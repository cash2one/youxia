{% extends 'layout.html' %} {% block title %}{{post.title}}- 游侠{% endblock %} {% block stylesheet %} {% endblock %} {% block main %}
<main class="App-content">
  <div id="content" style="padding-bottom: 0px;">
    <div class="DiscussionPage">
      <div class="DiscussionPage-discussion">
        <div class="container">
          <nav class="DiscussionPage-nav">
            <ul>
              <li class="item-controls {%if not user_info%}logIn{%endif%}">
                <div class="ButtonGroup Dropdown dropdown App-primaryControl Dropdown--split itemCount1">
                  <button class=" SplitDropdown-button Button Button--primary hasIcon" type="button" title="回复"> <i class="icon fa fa-fw fa-reply Button-icon"></i>
                    <span class="Button-label">回复</span>
                  </button>
                  <button class="Dropdown-toggle Button Button--icon Button--primary" data-toggle="dropdown"> <i class="icon fa fa-fw fa-ellipsis-v Button-icon"></i>
                    <i class="icon fa fa-fw fa-caret-down Button-caret"></i>
                  </button>
                  <ul class="Dropdown-menu dropdown-menu  Dropdown-menu--right">
                    <li class="item-reply">
                      <button class=" hasIcon" type="button" title="回复">
                        <i class="icon fa fa-fw fa-reply Button-icon"></i>
                        <span class="Button-label">回复</span>
                      </button>
                    </li>
                  </ul>
                </div>
              </li>
              <li class="item-subscription {%if not user_info%}logIn{%endif%}">
                <div class="Dropdown ButtonGroup SubscriptionMenu">
                  <button class="Button SubscriptionMenu-button SubscriptionMenu-button--false hasIcon" title="" type="button" data-original-title="Get an email when there are new posts">
                    <i class="icon fa fa-fw fa-star-o Button-icon"></i>
                    <span class="Button-label">关注</span>
                  </button>
                  <button class="Dropdown-toggle Button Button--icon SubscriptionMenu-button--false" data-toggle="dropdown">
                    <i class="icon fa fa-fw fa-caret-down Button-icon"></i>
                  </button>
                  <ul class="Dropdown-menu dropdown-menu Dropdown-menu--right">
                    <li>
                      <button class="SubscriptionMenuItem hasIcon">
                        <i class="icon fa fa-fw fa-check Button-icon"></i>
                        <span class="SubscriptionMenuItem-label">
                          <i class="icon fa fa-fw fa-star-o Button-icon"></i> <strong>取消关注</strong>
                          <span class="SubscriptionMenuItem-description">仅在有人@提到我时提醒我.</span>
                        </span>
                      </button>
                    </li>
                    <li>
                      <button class="SubscriptionMenuItem hasIcon">
                        <span class="SubscriptionMenuItem-label">
                          <i class="icon fa fa-fw fa-star Button-icon"></i> <strong>正在关注</strong>
                          <span class="SubscriptionMenuItem-description">当有人回复此帖子时提醒我.</span>
                        </span>
                      </button>
                    </li>
                    <li>
                      <button class="SubscriptionMenuItem hasIcon">
                        <span class="SubscriptionMenuItem-label">
                          <i class="icon fa fa-fw fa-eye-slash Button-icon"></i>
                          <strong>忽略</strong>
                          <span class="SubscriptionMenuItem-description">不接收任何提醒并隐藏此帖子.</span>
                        </span>
                      </button>
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </nav>
          <div class="DiscussionPage-stream">
            <div class="PostStream">
              <div class="PostStream-item" data-index="0" data-time="{{post.created}}" data-number="0" data-id="{{post.id}}" data-type="comment" style="display: block;">
                <article class="Post undefined CommentPost Post--edited">
                  <div>
                    <div class="Post-tags">
                      <span class="TagsLabel ">
                        <a class="TagLabel  colored" title="基于 Flarum 轻论坛的中文增强发行版，集成了一些比较实用的插件，使其更符合国内场景" href="/t/flarumone" style="color: rgb(239, 86, 79); background-color: rgb(239, 86, 79);">
                          <span class="TagLabel-text">版块</span>
                        </a><a class="TagLabel" title="" href="/tag/{{post.board}}"><span class="TagLabel-text">{{post.board}}</span></a>
                      </span>
                      <span class="TagsLabel ">
                        <a class="TagLabel  colored" title="" href="/t/fix" style="color: rgb(155, 193, 102); background-color: rgb(155, 193, 102);">
                          <span class="TagLabel-text">车型</span>
                        </a><a class="TagLabel" title="{{post.models}}" href="/tag/{{post.models}}">
                          <span class="TagLabel-text">{{post.models}}</span>
                        </a>
                      </span>
                      <span class="TagsLabel ">
                        <a class="TagLabel  colored" title="" href="/t/fix" style="color: rgb(214, 139, 79); background-color: rgb(214, 139, 79);">
                          <span class="TagLabel-text">标签</span>
                        </a><a class="TagLabel" title="锁帖" href="/t/closed">
                          <span class="TagLabel-text">上海通用</span>
                        </a><a class="TagLabel" title="锁帖" href="/t/closed">
                          <span class="TagLabel-text">别克</span>
                        </a><a class="TagLabel" title="锁帖" href="/t/closed">
                          <span class="TagLabel-text">全新君越</span>
                        </a>
                      </span>
                    </div>
                    <header class="Post-header">
                      <ul>
                        <li class="item-user">
                          <div class="PostUser">
                            <h3>
                              <a href="/user/{{post.author_username}}">
                                {%if post.author_avatar%}
                                <img class="Avatar PostUser-avatar" src="{{post.author_avatar}}">
                                {%else%}
                                <span class="Avatar PostUser-avatar" style="background: {{post.author_color}};">{{post.author_username|format_username}}</span>
                                {%endif%}
                                <span class="username">{{post.author_username}}</span>
                              </a>
                            </h3>
                            <ul class="PostUser-badges badges"></ul>
                          </div>
                        </li>
                        <li class="item-meta">
                          <div class="Dropdown PostMeta">
                            <a class="Dropdown-toggle" data-toggle="dropdown">
                              <time pubdate="true" datetime="{{post.created}}" title="{{post.created}}" data-humantime="true">{{post.created|pretty_date}}</time>
                            </a>
                            <div class="Dropdown-menu dropdown-menu">
                              <span class="PostMeta-number">#0 楼</span>
                              <span class="PostMeta-time">
                                <time pubdate="true" datetime="2016-04-27T08:34:10+08:00">{{post.created}}</time>
                              </span>
                              <span class="PostMeta-ip"></span>
                              <input class="FormControl PostMeta-permalink"></div>
                          </div>
                        </li>
                      </ul>
                    </header>
                    <div class="Post-title">
                      <h2 class="DiscussionHero-title">{{post.title}}</h2>
                    </div>
                    <div class="Post-body">{{post.content}}</div>
                    <aside class="Post-actions">
                      <ul>
                        <li class="item-like {%if post.like_id%}liked{%endif%} {%if not user_info%}logIn{%endif%}">
                          <button class="Button Button--link" type="button" title="{%if post.like_id%}已赞{%else%}赞{%endif%}">
                            <span class="Button-label">{%if post.like_id%}已赞{%else%}赞{%endif%}</span>
                          </button>
                        </li>
                        <li class="item-reply {%if not user_info%}logIn{%endif%}">
                          <button class="Button Button--link" type="button" title="回复">
                            <span class="Button-label">回复</span>
                          </button>
                        </li>
                        <li>
                          <div class="ButtonGroup Dropdown dropdown Post-controls itemCount1">
                            <button class="Dropdown-toggle Button Button--icon Button--flat" data-toggle="dropdown">
                              <i class="icon fa fa-fw fa-ellipsis-h Button-icon"></i>
                              <span class="Button-label"></span>
                              <i class="icon fa fa-fw fa-caret-down Button-caret"></i>
                            </button>
                            <ul class="Dropdown-menu dropdown-menu Dropdown-menu--right">
                              {%if user_info.uid == post.author_id%}
                              <li class="item-edit">
                                <button class=" hasIcon" type="button" title="编辑">
                                  <i class="icon fa fa-fw fa-pencil Button-icon"></i>
                                  <span class="Button-label">编辑</span>
                                </button>
                              </li>
                              <li class="Dropdown-separator"></li>
                              <li class="item-hide">
                                <button class=" hasIcon" type="button" title="删除">
                                  <i class="icon fa fa-fw fa-trash-o Button-icon"></i>
                                  <span class="Button-label">删除</span>
                                </button>
                              </li>
                              {%else%}
                              <li class="item-flag {%if not user_info%}logIn{%endif%}">
                                <button class=" hasIcon" type="button" title="举报">
                                  <i class="icon fa fa-fw fa-flag Button-icon"></i>
                                  <span class="Button-label">举报</span>
                                </button>
                              </li>
                              {%endif%}
                            </ul>
                          </div>
                        </li>
                      </ul>
                    </aside>
                    <footer class="Post-footer">
                      <ul>
                        {%if post.like_users%}
                        <li class="item-liked">
                          <div class="Post-likedBy">
                            <i class="icon fa fa-fw fa-thumbs-o-up "></i>
                            <a href="/user/{{post.like_user}}">
                              <span class="username">{{post.like_users}}</span>
                            </a>
                            赞了它.
                          </div>
                        </li>
                        {%endif%} {%if post.reply_users%}
                        <li class="item-replies">
                          <div class="Post-mentionedBy">
                            <span class="Post-mentionedBy-summary">
                              <i class="icon fa fa-fw fa-reply "></i>
                              <a href="/post/{{post.id}}?reply=0" data-number="0">
                                <span class="username">{{post.reply_users}}</span>
                              </a>
                              回复了它.
                            </span>
                            <ul class="Dropdown-menu Post-mentionedBy-preview fade"></ul>
                          </div>
                        </li>
                        {%endif%}
                      </ul>
                    </footer>
                  </div>
                </article>
                <div class="Post-quoteButtonContainer"></div>
              </div>
              {%if 0%}
              <div class="PostStream-item" data-index="0" data-time="2015-10-16T11:25:18.000Z" data-number="2" data-id="382" style="display: block;">
                <article class="Post EventPost DiscussionTaggedPost">
                  <div>
                    <i class="icon fa fa-fw fa-tag EventPost-icon"></i>
                    <div class="EventPost-info">
                      <a class="EventPost-user" href="/u/admin">
                        <span class="username">admin</span>
                      </a>
                      添加
                      <span class="TagsLabel ">
                        <a class="TagLabel  colored" title="非程序核心的问题" href="/t/extensions" style="color: rgb(56, 203, 186); background-color: rgb(56, 203, 186);">
                          <span class="TagLabel-text">插件</span>
                        </a>
                      </span>
                      和 移除
                      <span class="TagsLabel ">
                        <a class="TagLabel  colored" title="非以上项目的问题，可以归类到该标签下" href="/t/other" style="color: rgb(157, 176, 175); background-color: rgb(157, 176, 175);">
                          <span class="TagLabel-text">其它</span>
                        </a>
                      </span>
                      标签
                    </div>
                    <aside class="Post-actions">
                      <ul></ul>
                    </aside>
                    <footer class="Post-footer">
                      <ul></ul>
                    </footer>
                  </div>
                </article>
              </div>
              <div class="PostStream-item" data-index="0" data-time="2015-10-16T11:30:03.000Z" data-number="3" data-id="383" style="display: block;">
                <article class="Post EventPost DiscussionStickiedPost">
                  <div>
                    <i class="icon fa fa-fw fa-thumb-tack EventPost-icon"></i>
                    <div class="EventPost-info">
                      <a class="EventPost-user" href="/u/admin">
                        <span class="username">admin</span>
                      </a>
                      置顶了此帖子
                    </div>
                    <aside class="Post-actions">
                      <ul></ul>
                    </aside>
                    <footer class="Post-footer">
                      <ul></ul>
                    </footer>
                  </div>
                </article>
              </div>
              <div class="PostStream-item" data-index="0" data-time="2016-06-23T23:06:38.000Z" data-number="43" data-id="27277" data-type="discussionRenamed" style="display: block;">
                <article class="Post undefined EventPost DiscussionRenamedPost">
                  <div>
                    <i class="icon fa fa-fw fa-pencil EventPost-icon"></i>
                    <div class="EventPost-info">
                      <span title="The old title was: &quot;International support&quot;">
                        <a class="EventPost-user" href="/u/Dominion">
                          <span class="username">Dominion</span>
                        </a>
                        changed the title to
                        <strong class="DiscussionRenamedPost-new">International support sites</strong>
                        .
                      </span>
                    </div>
                    <aside class="Post-actions">
                      <ul></ul>
                    </aside>
                    <footer class="Post-footer">
                      <ul></ul>
                    </footer>
                  </div>
                </article>
              </div>
              {%endif%}
              <div class="ReplyList"></div>
              <div class="DiscussionList-loadMore" data-pages="" data-current="" data-next="">
              <button class="Button" type="button" title="">
                <span class="Button-label">加载更多</span>
              </button>
            </div>
              <div class="PostStream-item">
                <article class="Post ReplyPlaceholder {%if not user_info%}logIn{%endif%}">
                  <header class="Post-header">
                    {%if user_info.avatar%}
                                <img class="Avatar PostUser-avatar" src="{{user_info.avatar}}">
                                {%else%}
                                <span class="Avatar PostUser-avatar" style="background: {{user_info.color}};">{{user_info.username|format_username}}</span>
                                {%endif%}
                    回复一发...
                  </header>
                </article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="flarum-loading" style="display: none;">Loading...</div>
  <div class="App-composer">
    <div class="container">
      <div id="composer">
        <div class="Composer" style="display: none; bottom: 0px; height: 300px;">
          <div class="Composer-handle" style="cursor: row-resize;"></div>
          <ul class="Composer-controls">
            <li class="item-minimize App-backControl">
              <button title="Minimize" itemclassname="App-backControl" class="Button Button--icon Button--link hasIcon" type="button">
                <i class="icon fa fa-fw fa-minus minimize Button-icon"></i>
              </button>
            </li>
            <li class="item-fullScreen">
              <button title="Full Screen" class="Button Button--icon Button--link hasIcon" type="button">
                <i class="icon fa fa-fw fa-expand Button-icon"></i>
              </button>
            </li>
            <li class="item-close">
              <button title="Close" class="Button Button--icon Button--link hasIcon" type="button">
                <i class="icon fa fa-fw fa-times Button-icon"></i>
              </button>
            </li>
          </ul>
          <div class="Composer-content">
            <div class="ComposerBody ">
              {%if user_info.avatar%}
                                <img class="Avatar ComposerBody-avatar" src="{{user_info.avatar}}">
                                {%else%}
                                <span class="Avatar ComposerBody-avatar" style="background: {{user_info.color}};">{{user_info.username|format_username}}</span>
                                {%endif%}
              <div class="ComposerBody-content">
                <ul class="ComposerBody-header">
                  <li class="item-title">
                    <h3>
                      <i class="icon fa fa-fw fa-reply "></i>
                      <a href="/post/{{post.id}}">{{post.title}}</a>
                    </h3>
                  </li>
                </ul>
                <div class="ComposerBody-editor">
                  <div class="TextEditor">
                    <div class="ComposerBody-emojiWrapper">
                      <div class="ComposerBody-mentionsWrapper">
                        <div class="FormControl Composer-flexible" placeholder="回复一发..." style="height: 192px;" contenteditable="true"></div>
                        <div class="ComposerBody-mentionsDropdownContainer"></div>
                      </div>
                      <div class="ComposerBody-emojiDropdownContainer"></div>
                    </div>
                    <ul class="TextEditor-controls Composer-footer">
                      <li class="item-submit App-primaryControl">
                        <button class="Button Button--primary hasIcon" itemclassname="App-primaryControl" type="button" title="Post Reply">
                          <i class="icon fa fa-fw fa-check Button-icon"></i>
                          <span class="Button-label">回复</span>
                        </button>
                      </li>
                      <li class="item-preview">
                        <button class="Button Button--icon hasIcon" type="button">
                          <i class="icon fa fa-fw fa-eye Button-icon"></i>
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
              <div class="LoadingIndicator ComposerBody-loading">
                <div class="spinner" style="position: absolute; width: 0px; z-index: auto; left: 50%; top: 50%;" role="progressbar">
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-0-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(0deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-1-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(45deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-2-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(90deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-3-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(135deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-4-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(180deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-5-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(225deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-6-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(270deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                  <div style="position: absolute; top: -1px; opacity: 0.25; animation: opacity-100-25-7-8 1s linear infinite;">
                    <div style="position: absolute; width: 7px; height: 3px; box-shadow: rgba(0, 0, 0, 0.0980392) 0px 0px 1px; transform-origin: left center 0px; transform: rotate(315deg) translate(5px, 0px); border-radius: 1px; background: rgb(102, 125, 153);"></div>
                  </div>
                </div>
                &nbsp;
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %} {% block modal %}
<div id="modal">
  <div class="ModalManager modal fade" style=""></div>
</div>
{% endblock %} {% block javascript %}
<script src="{{static_path}}/js/timeago.min.js"></script>
<script type="text/javascript">
function showReplys(data) {
                    var all_replys_text = '';
                    var all_replys = data.list;
                    for (var i = 0; i < all_replys.length; i++) {
                        var reply = all_replys[i];

                        var index = i + 1;
                        var avatar_text;
                        if (reply.author_avatar) {
                            avatar_text = '<img class="Avatar PostUser-avatar" src="' + reply.author_avatar + '">';
                        } else {
                            avatar_text = '<span class="Avatar PostUser-avatar" style="background: '+reply.author_color+'; text-transform: capitalize;">' + reply.author_username.substring(0, 1) + '</span>';
                        }
                        var like_users_text = '';
                        if (reply.like_users) {
                            like_users_text = '<li class="item-liked"><div class="Post-likedBy"><i class="icon fa fa-fw fa-thumbs-o-up "></i><a href="/user/' + reply.like_users + '"><span class="username">' + reply.like_users + '</span></a> 赞了它.</div></li>';
                        }
                        var reply_users_text = '';
                        if (reply.reply_users) {
                            reply_users_text = '<li class="item-replies"><div class="Post-mentionedBy"><span class="Post-mentionedBy-summary"><i class="icon fa fa-fw fa-reply "></i><a href="/post/{{post.id}}?reply=' + index + '" data-number="31"><span class="username">' + reply.reply_users + '</span></a> 回复了它.</span><ul class="Dropdown-menu Post-mentionedBy-preview fade"></ul></div></li>';
                        }
                        var like_button = '';
                        if (reply.like_id) {
                            like_button = '<li class="item-like liked {%if not user_info%}logIn{%endif%}"><button class="Button Button--link" type="button" title="已赞"><span class="Button-label">已赞</span></button></li>';
                        } else {
                            like_button = '<li class="item-like {%if not user_info%}logIn{%endif%}"><button class="Button Button--link" type="button" title="赞"><span class="Button-label">赞</span></button></li>';
                        }

                        var Dropdown_menu = '';
                        if (String(reply.author_id) == "{{user_info.uid}}") {
                            Dropdown_menu = '<li class="item-edit"><button class=" hasIcon" type="button" title="编辑"><i class="icon fa fa-fw fa-pencil Button-icon"></i><span class="Button-label">编辑</span></button></li><li class="Dropdown-separator"></li><li class="item-hide"><button class=" hasIcon" type="button" title="删除"><i class="icon fa fa-fw fa-trash-o Button-icon"></i><span class="Button-label">删除</span></button></li>';
                        } else {
                            Dropdown_menu = '<li class="item-flag {%if not user_info%}logIn{%endif%}"><button class=" hasIcon" type="button" title="举报"><i class="icon fa fa-fw fa-flag Button-icon"></i><span class="Button-label">举报</span></button></li></ul></div></li>';
                        }
                        var created = new timeago(null, 'zh_CN').format(reply.created);
                        var reply_text = '<div class="PostStream-item" data-index="' + index + '" data-time="' + reply.created + '" data-number="' + index + '" data-id="' + reply.id + '" data-type="comment" style="display: block;"><article class="Post undefined CommentPost"><div><header class="Post-header"><ul><li class="item-user"><div class="PostUser"><h3><a href="/user/' + reply.author_username + '">' + avatar_text + '<span class="username">' + reply.author_username + '</span></a></h3><ul class="PostUser-badges badges"></ul></div></li><li class="item-meta"><div class="Dropdown PostMeta"><a class="Dropdown-toggle" data-toggle="dropdown"><time pubdate="true" datetime="' + reply.created + '" title="' + reply.created + '" data-humantime="true">' + created + '</time></a><div class="Dropdown-menu dropdown-menu"><span class="PostMeta-number">#' + index + ' 楼</span> <span class="PostMeta-time"><time pubdate="true" datetime="' + reply.created + '">' + reply.created + '</time></span> <span class="PostMeta-ip"></span><input class="FormControl PostMeta-permalink"></div></div><span class="item-index">#' + index + '</span></li></ul></header><div class="Post-body">' + reply.content + '</div><aside class="Post-actions"><ul>' + like_button + '<li class="item-reply {%if not user_info%}logIn{%endif%}"><button class="Button Button--link" type="button" title="回复"><span class="Button-label">回复</span></button></li><li><div class="ButtonGroup Dropdown dropdown Post-controls itemCount1"><button class="Dropdown-toggle Button Button--icon Button--flat" data-toggle="dropdown"><i class="icon fa fa-fw fa-ellipsis-h Button-icon"></i><span class="Button-label"></span><i class="icon fa fa-fw fa-caret-down Button-caret"></i></button><ul class="Dropdown-menu dropdown-menu Dropdown-menu--right">' + Dropdown_menu + '</ul></aside><footer class="Post-footer"><ul>' + like_users_text + reply_users_text + '</ul></footer></div></article><div class="Post-quoteButtonContainer"></div></div>';
                        all_replys_text += reply_text;

                    }

                    $('.DiscussionList-loadMore').before(all_replys_text);

                    var loadMore = $('.DiscussionList-loadMore');
        loadMore.attr('data-pages', data.page.pages);
        loadMore.attr('data-current', data.page.current);
        loadMore.attr('data-next', data.page.next);

        if (data.page.pages == data.page.current) {
          loadMore.find('.Button-label').text('没有更多了');
          loadMore.find('button').addClass('disabled');
        }
}


function getSelected() {
    if (window.getSelection) {
        return window.getSelection();
    } else if (document.getSelection) {
        return document.getSelection();
    } else {
        var selection = document.selection && document.selection.createRange();
        if (selection.text) {
            return selection.text;
        }
        return false;
    }
    return false;
}

$(document).ready(function() {
  $.getJSON('/reply/{{post.id}}?page=1', function(data) {
        showReplys(data);
  });

  $(document).on('click', '.DiscussionList-loadMore', function() {
      var loadMore = $(this);
      var pages = $(this).attr('data-pages');
      var current = $(this).attr('data-current');
      var next = $(this).attr('data-next');

      if (current == pages) {
        return;
      }
      $.getJSON('/reply/{{post.id}}?page=' + next, function(data) {
        showReplys(data);
      });
    });


    $(document).on('mouseup', '.Post-body', function(e) {
        var selection = getSelected();

        if (selection != '') {
            var xx = e.pageX;
            var yy = e.pageY;

            var PostStream_item = $(this).parent().parent().parent();
            PostStream_item.find('.Post-quoteButtonContainer').append('<button class="Button PostQuoteButton hasIcon {%if not user_info%}logIn{%endif%}" type="button" title="Quote" style="left: ' + xx + 'px; top: ' + yy + 'px; display: block;" data-text="' + selection + '"><i class="icon fa fa-fw fa-quote-left Button-icon"></i><span class="Button-label">引用</span></button>');
        }
    });



    $(document).on('mousedown', 'body', function(e) {
        e = window.event || e; // 兼容IE7
        obj = $(e.srcElement || e.target);
        if ($(obj).is(".PostQuoteButton,.PostQuoteButton *")) {
            // alert('内部区域'); 
        } else {
            $('.PostQuoteButton').remove();
        }
    });


    $(document).on('mouseenter', '.CommentPost .PostUser-avatar', function(e) {
        var avatar_text = $(this).removeClass('PostUser-avatar').prop("outerHTML");
        $(this).addClass('PostUser-avatar');
        var username_text = $(this).parent().find('.username').prop("outerHTML");
        $(this).parent().parent().parent().append('<div class="UserCard UserCard--popover" style="background-color: rgb(222, 160, 229);"><div class="darkenBackground"><div class="container"><div class="UserCard-profile"><h2 class="UserCard-identity"><a href="/u/wowmac"><div class="UserCard-avatar">' + avatar_text + '</div>' + username_text + '</a></h2><ul class="UserCard-info"><li class="item-bio"><div class="UserBio "><div class="UserBio-content"></div></div></li><li class="item-lastSeen"><span class="UserCard-lastSeen"><i class="icon fa fa-fw fa-clock-o "></i> 19 小时前</span></li><li class="item-joined">加入于 20 小时前</li></ul></div></div></div></div>');
        setTimeout(function() {
            $('.UserCard--popover').addClass('in');
        }, 200);
    });

    $(document).on('mouseenter', 'h3 .username', function(e) {
        var avatar = $(this).parent().find('.PostUser-avatar')
        var avatar_text = avatar.removeClass('PostUser-avatar').prop("outerHTML");
        avatar.addClass('PostUser-avatar');
        var username_text = $(this).prop("outerHTML");
        $(this).parent().parent().parent().append('<div class="UserCard UserCard--popover" style="background-color: rgb(222, 160, 229);"><div class="darkenBackground"><div class="container"><div class="UserCard-profile"><h2 class="UserCard-identity"><a href="/u/wowmac"><div class="UserCard-avatar">' + avatar_text + '</div>' + username_text + '</a></h2><ul class="UserCard-info"><li class="item-bio"><div class="UserBio "><div class="UserBio-content"></div></div></li><li class="item-lastSeen"><span class="UserCard-lastSeen"><i class="icon fa fa-fw fa-clock-o "></i> 19 小时前</span></li><li class="item-joined">加入于 20 小时前</li></ul></div></div></div></div>');
        setTimeout(function() {
            $('.UserCard--popover').addClass('in');
        }, 200);
    });

    $(document).on('mouseleave', '.UserCard--popover', function(e) {
        $('.UserCard--popover').removeClass('in');
        setTimeout(function() {
            $('.UserCard--popover').remove();
        }, 200);

    });



    {%if user_info%}
    $(document).on('click', '.PostQuoteButton', function(e) {
        //alert('dddd');
        $('.Composer').addClass('normal');
        $('.Composer').addClass('visible');
        $('.Composer').css("display", "block");

        $('.Composer .Composer-flexible').append('<blockquote class="uncited"><div><p><a href="https://discuss.flarum.org/d/2352/3" class="PostMention" data-id="20296">BlackSheep</a> ' + $(this).attr('data-text') + '</p></div></blockquote><br>');
    });

    $(document).on('click', '.item-flag', function() {
        var modal = '<div class="Modal modal-dialog FlagPostModal Modal--small"><div class="Modal-content"><div class="Modal-close App-backControl"><button class="Button Button--icon Button--link hasIcon" type="button"><i class="icon fa fa-fw fa-times Button-icon"></i></button></div><form><div class="Modal-header"><h3 class="App-titleControl App-titleControl--text">Flag Post</h3></div><div class="Modal-alert"></div><div class="Modal-body"><div class="Form Form--centered"><div class="Form-group"><div><label class="checkbox"><input type="radio" name="reason" value="off_topic"><strong>Off-topic</strong>This post is not relevant to the current discussion and should be moved elsewhere.</label><label class="checkbox"><input type="radio" name="reason" value="inappropriate"><strong>Inappropriate</strong>This post is offensive, abusive, or violates our <a>community guidelines</a>.</label><label class="checkbox"><input type="radio" name="reason" value="spam"><strong>Spam</strong>This post is an advertisement.</label><label class="checkbox"><input type="radio" name="reason" value="other"><strong>Other</strong></label></div></div><div class="Form-group"><button class="Button Button--primary Button--block disabled" type="submit" disabled="" title="Flag Post"><span class="Button-label">Flag Post</span></button></div></div></div></form></div></div>';
        $('.ModalManager').html(modal);
        $('.modal').modal('show');
    });

    $(document).on('click', '.item-controls', function() {
        $('.Composer').addClass('normal');
        $('.Composer').addClass('visible');
        $('.Composer').css("display", "block");

        $('html, body').animate({
            scrollTop: $(document).height()
        }, 1000);
    });

    $(document).on('click', '.ReplyPlaceholder', function() {
        $('.Composer').addClass('normal');
        $('.Composer').addClass('visible');
        $('.Composer').css("display", "block");
    });

    $(document).on('click', '.item-submit', function() {
        $('.ComposerBody-loading').addClass('active');
        var content = $('.Composer-flexible').html();

        var data_reply = $(this).attr('data-reply');
        var data_id = $(this).attr('data-id');
        if (data_reply == undefined) {
            data_reply = 'to_post';
        }
        if (data_id == undefined) {
            data_id = '{{post.id}}';
        }
        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            url: "/reply/{{post.id}}",
            data: JSON.stringify({
                content: content,
                reply_type: data_reply,
                reply_to: data_id
            }),
            success: function(msg) {
                if (msg.success == 1) {
                  console.log(msg);
                    $('.ComposerBody-loading').removeClass('active');
                    $('.Composer-flexible').val("");
                    $('.Composer').removeClass('normal');
                    $('.Composer').removeClass('active');
                    $('.Composer').removeClass('visible');
                    $('.Composer').css("display", "none");
                    var reply = msg.reply_info;
                     var avatar_text;
                        if (reply.author_avatar) {
                            avatar_text = '<img class="Avatar PostUser-avatar" src="' + reply.author_avatar + '">';
                        } else {
                            avatar_text = '<span class="Avatar PostUser-avatar" style="background: '+reply.author_color+'; text-transform: capitalize;">' + reply.author_username.substring(0, 1) + '</span>';
                        }
                        var like_users_text = '';
                        var reply_users_text = '';

                        var like_button = '<li class="item-like {%if not user_info%}logIn{%endif%}"><button class="Button Button--link" type="button" title="赞"><span class="Button-label">赞</span></button></li>';
                      

                        var Dropdown_menu = '<li class="item-edit"><button class=" hasIcon" type="button" title="编辑"><i class="icon fa fa-fw fa-pencil Button-icon"></i><span class="Button-label">编辑</span></button></li><li class="Dropdown-separator"></li><li class="item-hide"><button class=" hasIcon" type="button" title="删除"><i class="icon fa fa-fw fa-trash-o Button-icon"></i><span class="Button-label">删除</span></button></li>';

                        var created = new timeago(null, 'zh_CN').format(reply.created);
                        var reply_text = '<div class="PostStream-item" data-index="' + '0' + '" data-time="' + reply.created + '" data-number="' + '0' + '" data-id="' + reply.id + '" data-type="comment" style="display: block;"><article class="Post undefined CommentPost"><div><header class="Post-header"><ul><li class="item-user"><div class="PostUser"><h3><a href="/user/' + reply.author_username + '">' + avatar_text + '<span class="username">' + reply.author_username + '</span></a></h3><ul class="PostUser-badges badges"></ul></div></li><li class="item-meta"><div class="Dropdown PostMeta"><a class="Dropdown-toggle" data-toggle="dropdown"><time pubdate="true" datetime="' + reply.created + '" title="' + reply.created + '" data-humantime="true">' + created + '</time></a><div class="Dropdown-menu dropdown-menu"><span class="PostMeta-number">#' + '0' + ' 楼</span> <span class="PostMeta-time"><time pubdate="true" datetime="' + reply.created + '">' + reply.created + '</time></span> <span class="PostMeta-ip"></span><input class="FormControl PostMeta-permalink"></div></div><span class="item-index">#' + '0' + '</span></li></ul></header><div class="Post-body">' + reply.content + '</div><aside class="Post-actions"><ul>' + like_button + '<li class="item-reply {%if not user_info%}logIn{%endif%}"><button class="Button Button--link" type="button" title="回复"><span class="Button-label">回复</span></button></li><li><div class="ButtonGroup Dropdown dropdown Post-controls itemCount1"><button class="Dropdown-toggle Button Button--icon Button--flat" data-toggle="dropdown"><i class="icon fa fa-fw fa-ellipsis-h Button-icon"></i><span class="Button-label"></span><i class="icon fa fa-fw fa-caret-down Button-caret"></i></button><ul class="Dropdown-menu dropdown-menu Dropdown-menu--right">' + Dropdown_menu + '</ul></aside><footer class="Post-footer"><ul>' + like_users_text + reply_users_text + '</ul></footer></div></article><div class="Post-quoteButtonContainer"></div></div>';

                    $('.DiscussionList-loadMore').before(reply_text);
                    if (data_type == 'to_reply') {
                        var data_index = $("[data-id='" + data_id + "']").attr("data-index");
                        $("[data-id='" + data_id + "']").find('footer ul').append('<li class="item-replies"><div class="Post-mentionedBy"><span class="Post-mentionedBy-summary"><i class="icon fa fa-fw fa-reply "></i><a href="/post/{{post.id}}?reply=' + data_index + '" data-number="' + data_index + '"><span class="username">你</span></a> 回复了它.</span><ul class="Dropdown-menu Post-mentionedBy-preview fade"></ul></div></li>');
                    }

                    $('html, body').animate({
                        scrollTop: $(document).height()
                    }, 1000);


                }
            },
            error: function(msg) {
                alert("error");
            }
        });
    });


    $(document).on('click', '.item-reply', function() {
        $('.Composer').addClass('normal');
        $('.Composer').addClass('visible');
        $('.Composer').css("display", "block");

        var item = $(this).parent().parent().parent().parent().parent();
        var data_id = item.attr('data-id');
        var data_index = item.attr('data-index');
        var username = item.find('.PostUser .username').text();
        //$('.Composer textarea').val('@'+username+'#'+data_id+' ');
        $('.Composer .Composer-flexible').append('<a href="/post/{{post.id}}?reply=' + data_index + '" class="PostMention" data-id="' + data_id + '">' + username + '</a>&nbsp;');

        $('.item-submit').attr('data-reply', 'to_reply');
        $('.item-submit').attr('data-id', data_id);
    });

    $(document).on('click', '.item-like', function() {
        var item_like = $(this);
        if (item_like.hasClass('liked')) {
            return;
        }
        var item = $(this).parent().parent().parent().parent().parent();
        var data_id = item.attr('data-id');
        var data_index = item.attr('data-index');
        var like_type = '';
        if (data_index=='0') {
          like_type = 'to_post';
        } else {
          like_type = 'to_reply';
        }
        $.getJSON('/like/' + data_id + '?like_type=' + like_type, function(data) {
            if (data.success == 1) {
                item_like.find('span').text('已赞');
                item_like.addClass('liked');
                item.find('footer ul').append('<li class="item-liked"><div class="Post-likedBy"><i class="icon fa fa-fw fa-thumbs-o-up "></i><a href="/user/{{user_info.username}}"><span class="username">你</span></a> 赞了它.</div></li>');
            } else {
                alert('error');
            }
        });
    }); 
    {% endif %}
});
</script>
{% endblock %}